generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProfileType {
  searching_sibling
  searching_child
  searching_parent
  searching_relative
}

enum Gender {
  male
  female
  unknown
}

enum ContactRequestStatus {
  pending
  accepted
  rejected
}

enum Role {
  user
  moder
  administrator
  admin
}

model User {
  id              String    @id @default(uuid())
  phone           String    @unique
  phoneVerified   Boolean   @default(false)
  role            Role      @default(user)
  username        String?   @unique
  password        String?
  isBanned        Boolean   @default(false)
  bannedAt        DateTime?
  banReason       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  profiles        Profile[]
  contactRequests ContactRequest[] @relation("SentRequests")
  searchAlerts    SearchAlert[]
  verificationCodes VerificationCode[]
  refreshTokens   RefreshToken[]
  auditLogs       AuditLog[]
}

model VerificationCode {
  id        String   @id @default(uuid())
  userId    String
  code      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Profile {
  id                    String      @id @default(uuid())
  userId                String
  type                  ProfileType
  firstName             String
  lastName              String?
  birthDate             DateTime?
  birthDateApproximate  Boolean     @default(false)
  birthYear             Int?
  birthMonth            Int?
  birthDay              Int?
  birthPlace            String?
  maternityHospital     String?
  lastKnownLocation     String?
  region                String?
  gender                Gender      @default(unknown)
  story                 String?     @db.Text
  biologicalMotherInfo  Json?
  biologicalFatherInfo  Json?
  medicalHistory        String?     @db.Text
  myBirthYear           Int?
  myBirthMonth          Int?
  myBirthDay            Int?
  isActive              Boolean     @default(true)
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  photos          Photo[]
  contactRequests ContactRequest[]

  @@index([userId])
  @@index([type])
  @@index([region])
  @@index([birthYear])
  @@index([birthMonth])
  @@index([birthDay])
  @@index([maternityHospital])
  @@index([myBirthYear])
  @@index([myBirthMonth])
  @@index([myBirthDay])
  @@index([isActive])
}

model Photo {
  id        String   @id @default(uuid())
  profileId String
  url       String
  publicId  String?
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())

  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
}

model ContactRequest {
  id          String               @id @default(uuid())
  fromUserId  String
  toProfileId String
  message     String?              @db.Text
  status      ContactRequestStatus @default(pending)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  fromUser  User      @relation("SentRequests", fields: [fromUserId], references: [id], onDelete: Cascade)
  toProfile Profile   @relation(fields: [toProfileId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@unique([fromUserId, toProfileId])
  @@index([fromUserId])
  @@index([toProfileId])
  @@index([status])
}

model Message {
  id               String         @id @default(uuid())
  contactRequestId String
  senderId         String
  content          String         @db.Text
  isRead           Boolean        @default(false)
  createdAt        DateTime       @default(now())

  contactRequest ContactRequest @relation(fields: [contactRequestId], references: [id], onDelete: Cascade)

  @@index([contactRequestId])
  @@index([senderId])
  @@index([isRead])
}

model SearchAlert {
  id        String   @id @default(uuid())
  userId    String
  filters   Json
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
}

model AuditLog {
  id        String   @id @default(uuid())
  adminId   String?
  action    String
  targetId  String?
  details   Json?
  createdAt DateTime @default(now())

  admin User? @relation(fields: [adminId], references: [id], onDelete: SetNull)

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
}
